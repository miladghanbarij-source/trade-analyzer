<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار تحلیل تکنیکال با هوش مصنوعی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #0d1b2a 0%, #0f3d3e 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        textarea::placeholder {
            color: #ffffff;
        }
        #image-result-container {
            position: relative;
        }
        #result-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Allows clicks to go through to the image if needed */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl glass-card rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white">تحلیلگر نمودار با هوش مصنوعی</h1>
            <p class="text-green-200 mt-2">تصویر نمودار و درخواست خود را وارد کنید تا تحلیل متنی و تصویری دریافت کنید.</p>
        </div>

        <div>
            <label for="chart-image" class="block text-lg font-medium text-green-100 mb-2">۱. آپلود تصویر نمودار</label>
            <div id="drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-green-300 border-dashed rounded-md cursor-pointer hover:border-green-400 transition-colors">
                <div class="space-y-1 text-center">
                    <svg class="mx-auto h-12 w-12 text-green-200" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <div class="flex text-sm text-green-200"><p class="pl-1">فایل را بکشید و رها کنید یا برای انتخاب کلیک کنید</p><input id="chart-image" name="chart-image" type="file" class="sr-only" accept="image/*"></div>
                    <p class="text-xs text-green-300">PNG, JPG, GIF up to 10MB</p>
                </div>
            </div>
            <div id="image-preview" class="mt-4 hidden"></div>
        </div>

        <div>
            <label for="user-prompt" class="block text-lg font-medium text-green-100">۲. درخواست تحلیل</label>
            <textarea id="user-prompt" rows="4" class="mt-2 block w-full bg-white/10 border border-green-300 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-400 sm:text-sm" placeholder="مثلا: این نمودار بیت‌کوین در تایم‌فریم روزانه است. با توجه به اندیکاتور RSI و خطوط روند، نقاط حمایت و مقاومت کلیدی را مشخص کن و بگو آیا الان برای ورود مناسب است یا باید منتظر پولبک ماند؟"></textarea>
        </div>

        <div>
            <button id="analyze-button" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                <svg id="button-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span id="button-text">تحلیل کن</span>
            </button>
        </div>

        <div id="result-container" class="pt-6 hidden">
            <h2 class="text-2xl font-bold text-white border-b-2 border-green-400 pb-2 mb-4">نتیجه تحلیل</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div>
                    <h3 class="text-xl font-semibold text-green-200 mb-2">تحلیل متنی</h3>
                    <div id="result-text" class="prose prose-invert max-w-none text-green-100 whitespace-pre-wrap leading-relaxed bg-black/20 p-4 rounded-lg h-full"></div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-green-200 mb-2">تحلیل تصویری</h3>
                    <div id="image-result-container" class="bg-black/20 rounded-lg p-2 flex items-center justify-center min-h-[200px]">
                        <img id="result-image" src="" alt="تحلیل تصویری" class="max-w-full h-auto rounded-md hidden">
                        <canvas id="result-canvas"></canvas>
                        <p id="image-placeholder" class="text-green-300">تصویر تحلیل شده در اینجا نمایش داده می‌شود.</p>
                    </div>
                </div>
            </div>
            <div id="error-message" class="mt-4 p-4 bg-red-500/30 text-red-200 border border-red-500 rounded-md hidden"></div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('chart-image');
        const dropZone = document.getElementById('drop-zone');
        const imagePreview = document.getElementById('image-preview');
        const userPrompt = document.getElementById('user-prompt');
        const analyzeButton = document.getElementById('analyze-button');
        const buttonSpinner = document.getElementById('button-spinner');
        const buttonText = document.getElementById('button-text');
        const resultContainer = document.getElementById('result-container');
        const resultText = document.getElementById('result-text');
        const errorMessage = document.getElementById('error-message');
        const resultImage = document.getElementById('result-image');
        const resultCanvas = document.getElementById('result-canvas');
        const imagePlaceholder = document.getElementById('image-placeholder');
        
        let imageFile = null;
        let originalImageDimensions = { w: 0, h: 0 };
        let lastAnalysisData = null;
        
        dropZone.addEventListener('click', () => imageInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-green-400', 'bg-white/20'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-green-400', 'bg-white/20'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-green-400', 'bg-white/20');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                imageInput.files = files;
                handleImageSelection(files[0]);
            }
        });
        imageInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { handleImageSelection(e.target.files[0]); } });

        function handleImageSelection(file) {
            imageFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImageDimensions = { w: img.width, h: img.height };
                };
                img.src = event.target.result;
                imagePreview.innerHTML = `<p class="text-sm font-medium text-green-200 mb-2">تصویر انتخاب شده:</p><img src="${event.target.result}" alt="Chart preview" class="max-h-60 w-auto mx-auto rounded-lg shadow-md">`;
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        analyzeButton.addEventListener('click', async () => {
            if (!imageFile || !userPrompt.value.trim()) {
                showError("لطفاً هم تصویر نمودار را آپلود کنید و هم درخواست تحلیل خود را بنویسید.");
                return;
            }
            setLoading(true);
            hideError();

            try {
                const base64ImageData = await fileToBase64(imageFile);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageData: base64ImageData,
                        imageType: imageFile.type,
                        userPrompt: userPrompt.value,
                        originalDimensions: originalImageDimensions
                    }),
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `خطای سرور: ${response.status}`);
                }
                
                lastAnalysisData = result;
                displayResult(result);

            } catch (error) {
                console.error('Error during analysis:', error);
                showError(`خطایی رخ داد: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        function drawAnnotations(annotations) {
            const displayedImage = document.getElementById('result-image');
            const rect = displayedImage.getBoundingClientRect();
            const canvas = document.getElementById('result-canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = rect.width;
            canvas.height = rect.height;

            const scaleX = canvas.width / originalImageDimensions.w;
            const scaleY = canvas.height / originalImageDimensions.h;

            ctx.clearRect(0, 0, canvas.width, canvas.height); 

            annotations.forEach(ann => {
                ctx.strokeStyle = ann.color || 'yellow';
                ctx.fillStyle = ann.color || 'yellow';
                ctx.lineWidth = 2;
                ctx.font = `${14 * Math.min(scaleX, scaleY)}px Vazirmatn`;

                if (ann.type === 'line') {
                    ctx.beginPath();
                    ctx.moveTo(ann.startX * scaleX, ann.startY * scaleY);
                    ctx.lineTo(ann.endX * scaleX, ann.endY * scaleY);
                    ctx.stroke();
                } else if (ann.type === 'rect') {
                    ctx.globalAlpha = 0.3;
                    ctx.fillRect(ann.x * scaleX, ann.y * scaleY, ann.width * scaleX, ann.height * scaleY);
                    ctx.globalAlpha = 1.0;
                    ctx.strokeRect(ann.x * scaleX, ann.y * scaleY, ann.width * scaleX, ann.height * scaleY);
                } else if (ann.type === 'text') {
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(ann.text, ann.x * scaleX, ann.y * scaleY);
                }
            });
        }

        function setLoading(isLoading) {
            analyzeButton.disabled = isLoading;
            buttonSpinner.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'در حال تحلیل...' : 'تحلیل کن';
        }

        function displayResult(data) {
            resultContainer.classList.remove('hidden');
            resultText.innerText = data.analysisText;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                resultImage.src = event.target.result;
                resultImage.classList.remove('hidden');
                resultImage.onload = () => {
                    if(lastAnalysisData) {
                        drawAnnotations(lastAnalysisData.annotations);
                    }
                };
            };
            reader.readAsDataURL(imageFile);
            
            imagePlaceholder.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showError(message) {
            resultContainer.classList.add('hidden');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
             errorMessage.classList.add('hidden');
             errorMessage.textContent = '';
        }

        window.addEventListener('resize', () => {
            if (lastAnalysisData && !resultContainer.classList.contains('hidden')) {
                drawAnnotations(lastAnalysisData.annotations);
            }
        });
    </script>
</body>
</html>
